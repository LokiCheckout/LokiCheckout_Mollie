<script>
    document.addEventListener('alpine:init', () => {
        window.mollie = null;
        window.mollieCardComponent = null;

        Alpine.data('LokiCheckoutMollieCreditcard', () => ({
                ...LokiCheckoutBaseComponentType,
                profileId: '',
                locale: '',
                testMode: true,
                initActions: {
                    ...LokiCheckoutBaseComponentType.initActions,
                    loadMollieScript() {
                        const script = document.createElement('script');
                        script.src = 'https://js.mollie.com/v1/mollie.js';
                        script.onload = () => this.renderMollieComponents();
                        document.head.append(script);
                    },
                    addSubmitEventListener() {

                    }
                },
                createComponent(componentType, domId) {
                    const component = window.mollie.createComponent(componentType);
                    const errorElement = document.getElementById(this.elementId + '-' + domId + '-error');

                    component.mount('#' + this.elementId + '-' + domId);
                    component.addEventListener('change', event => {
                        if (event.error && !event.touched) {
                            return;
                        }

                        if (event.error && event.touched) {
                            errorElement.textContent = event.error;
                            return true;
                        }

                        errorElement.textContent = '';
                        this.submit();
                    });
                },
                renderMollieComponents() {
                    window.mollie = Mollie(this.profileId, {
                        locale: this.locale,
                        testmode: this.testMode,
                    });

                    this.createComponent('cardNumber', 'card-number');
                    this.createComponent('cardHolder', 'card-holder');
                    this.createComponent('expiryDate', 'expiry-date');
                    this.createComponent('verificationCode', 'verification-code');
                }
                ,
                async submit() {
                    if (!window.mollie) {
                        console.log('<?= __('Mollie object unavailable') ?>');
                        return false;
                    }

                    const {token, error} = await window.mollie.createToken();

                    if (error) {
                        console.log('<?= __('Mollie Error') ?>', error);
                        return false;
                    }

                    if (!token) {
                        console.log('<?= __('Empty Mollie token') ?>');
                        return false;
                    }

                    this.post(token);
                }
            })
        );
    });
</script>
